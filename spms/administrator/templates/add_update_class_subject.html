{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">
        {% if obj %} Update Subjects {% else %} Add Subjects {% endif %}
    </h1>

    <!-- Display messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                <p>{{ message }}</p>
            </div>
        {% endfor %}
    {% endif %}

    <form method="post" action="{% if obj %}{% url 'update_class_subject' obj.id %}{% else %}{% url 'add_class_subject' %}{% endif %}">
        {% csrf_token %}
        
        <!-- Section Name -->
        <div class="form-row">
            <div class="col-md-4 mb-3">
                <label for="class_id">Class<span class="redstaric">*</span></label>
                <select class="form-control" id="class_id" name="class_id" required>
                    <option value="">Select a Class</option>
                    {% for class in classes %}
                    <option value="{{ class.id }}" {% if obj and obj.class_name.id == class.id %}selected{% endif %}>
                        {{ class.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label for="section_id">Section<span class="redstaric">*</span></label>
                <select class="form-control" id="section_id" name="section_id" required>
                    <option value="">Select a Section</option>
                    {% if obj %}
                        {% for section in obj.class_name.sections.all %}
                            <option value="{{ section.id }}" {% if obj.section_name.id == section.id %}selected{% endif %}>
                                {{ section.name }}
                            </option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>    
        </div>

        <!-- Add Subjects to Section -->
        <div class="form-row">
            <!-- Available Subjects -->
            <div class="col-md-5 mb-3">
                <label for="available_subjects">Available Subjects</label>
                <select multiple class="form-control" id="available_subjects" name="available_subjects">
                    {% for subject in available_subjects %}
                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Buttons -->
            <div class="col-md-2 mb-3 d-flex flex-column justify-content-center align-items-center">
                <button type="button" class="btn btn-primary mb-2" id="add_subjects_btn">Add &gt;</button>
                <button type="button" class="btn btn-primary mb-2" id="remove_subjects_btn">&lt; Remove</button>
                <button type="button" class="btn btn-secondary mb-2" id="add_all_subjects_btn">Add All</button>
                <button type="button" class="btn btn-secondary" id="remove_all_subjects_btn">Remove All</button>
            </div>
            
            <!-- Added Subjects -->
            <div class="col-md-5 mb-3">
                <label for="added_subjects">Added Subjects</label>
                <select multiple class="form-control" id="added_subjects" name="added_subjects">
                    {% for subject in added_subjects %}
                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Submit and Cancel Buttons -->
        <button type="submit" class="btn btn-primary">{% if obj %} Update {% else %} Submit {% endif %}</button>
        <a href="{% url 'class_subject_list' %}" class="btn btn-secondary ml-2">Cancel</a>
    </form>
</div>

<script>
    // Handle class selection change to load sections dynamically
    document.getElementById('class_id').addEventListener('change', function() {
        var classId = this.value;
        
        var addedSubjects = document.getElementById('added_subjects');
        addedSubjects.innerHTML = '';
        if (classId) {
            fetch(`/administrator/add_class_subject/?class_id=${classId}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                var sectionSelect = document.getElementById('section_id');
                sectionSelect.innerHTML = '<option value="">Select a Section</option>';
                data.sections.forEach(function(section) {
                    var option = document.createElement('option');
                    option.value = section.id;
                    option.textContent = section.name;
                    sectionSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
        }
    });

    document.getElementById('section_id').addEventListener('change', function () {
        const sectionId = this.value;
        const classId = document.getElementById('class_id').value;
    
        if (sectionId) {
            fetch(`/administrator/add_class_subject/?class_id=${classId}&section_id=${sectionId}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Populate already added subjects
                const addedSubjects = document.getElementById('added_subjects');

                addedSubjects.innerHTML = '';
                const addedSubjectIds = new Set();
                
                data.added_subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name;
                    addedSubjects.appendChild(option);
                    addedSubjectIds.add(subject.id);
                });

                const availableSubjects = document.getElementById('available_subjects');

                for (let i = 0; i < availableSubjects.options.length; i++) {
                    const option = availableSubjects.options[i];
                    const optionValue = parseInt(option.value);
                    if (addedSubjectIds.has(optionValue)) {
                        availableSubjects.remove(i);
                        i--;
                    }
                }
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
        }
    });
    
    // Handle adding and removing subjects
    document.getElementById('add_subjects_btn').addEventListener('click', function() {
        var availableSubjects = document.getElementById('available_subjects');
        var addedSubjects = document.getElementById('added_subjects');
        var selectedOptions = [...availableSubjects.selectedOptions];
        selectedOptions.forEach(function(option) {
            addedSubjects.appendChild(option);
        });
    });

    document.getElementById('remove_subjects_btn').addEventListener('click', function() {
        var availableSubjects = document.getElementById('available_subjects');
        var addedSubjects = document.getElementById('added_subjects');
        var selectedOptions = [...addedSubjects.selectedOptions];
        selectedOptions.forEach(function(option) {
            availableSubjects.appendChild(option);
        });
    });

    // Add all subjects to the "Added Subjects" list
    document.getElementById('add_all_subjects_btn').addEventListener('click', function() {
        var availableSubjects = document.getElementById('available_subjects');
        var addedSubjects = document.getElementById('added_subjects');
        var allOptions = [...availableSubjects.options];
        allOptions.forEach(function(option) {
            addedSubjects.appendChild(option);
        });
    });

    // Remove all subjects from the "Added Subjects" list
    document.getElementById('remove_all_subjects_btn').addEventListener('click', function() {
        var availableSubjects = document.getElementById('available_subjects');
        var addedSubjects = document.getElementById('added_subjects');
        var allOptions = [...addedSubjects.options];
        allOptions.forEach(function(option) {
            availableSubjects.appendChild(option);
        });
    });

    // Double click to add subjects
    document.getElementById('available_subjects').addEventListener('dblclick', function(e) {
        var availableSubjects = document.getElementById('available_subjects');
        var addedSubjects = document.getElementById('added_subjects');
        var selectedOptions = [...availableSubjects.selectedOptions];
        selectedOptions.forEach(function(option) {
            addedSubjects.appendChild(option);
        });
    });

    // Double click to remove subjects
    document.getElementById('added_subjects').addEventListener('dblclick', function(e) {
        var availableSubjects = document.getElementById('available_subjects');
        var addedSubjects = document.getElementById('added_subjects');
        var selectedOptions = [...addedSubjects.selectedOptions];
        selectedOptions.forEach(function(option) {
            availableSubjects.appendChild(option);
        });
    });

    // Validate for Added Subjects 
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.querySelector("form");
        const addedSubjects = document.getElementById("added_subjects");

        form.addEventListener("submit", function (event) {

            if (addedSubjects.options.length === 0) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'added_subjects';
                input.value = '';
                form.appendChild(input);
            }
            
            if (addedSubjects.options.length === 0) {
                alert("Please add at least one subject before submitting.");
                event.preventDefault();
            }
        });
    });
</script>
{% endblock %}